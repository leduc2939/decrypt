<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Document</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
          integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
            crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css" href="style.css" />      

</head>
<body>

      <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="staticBackdropLabel">Đúng nhận?</h5>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Sai cãi</button>
              <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Nhận</button>
            </div>
          </div>
        </div>
      </div>



<div class="container" id = "container">
    <button id="newGame">
        New Game
    </button>
    <button id="startNewRound" disabled>
        Start New Round
    </button>
    <div class="decryptr d-flex mt-4">
        <div class="decryptr--left ">
<!-- team 1 keywords -->
            <div class="decryptr--row">
                <div id="thua_word1" class="keyword1">
                    <span class="m-auto">?</span>
                </div>
            </div>

            <div class="decryptr--row">
                <div id="thua_word2" class="keyword1">
                    <span class="m-auto">?</span>
                </div>
            </div>

            <div class="decryptr--row">
                <div id="thua_word3" class="keyword1">
                    <span class="m-auto">?</span>
                </div>
            </div>

            <div class="decryptr--row">
                <div id="thua_word4" class="keyword1">
                    <span class="m-auto">?</span>
                </div>
            </div>

            <button class='giveClues' id="giveClues" disabled>
                Give Clues
            </button>

<!-- team 2 keywords -->
            <div class="decryptr--row">
                <div id="loser_word1" class="decryptr--item2">
                    <span class="m-auto">?</span>
                </div>
            </div>

            <div class="decryptr--row">
                <div id="loser_word2" class="decryptr--item2">
                    <span class="m-auto">?</span>
                </div>
            </div>

            <div class="decryptr--row">
                <div id="loser_word3" class="decryptr--item2">
                    <span class="m-auto">?</span>
                </div>
            </div>

            <div class="decryptr--row">
                <div id="loser_word4" class="decryptr--item2">
                    <span class="m-auto">?</span>
                </div>
            </div>
        </div>

        


        <div class="decryptr--right">
            <div class="decryptr--row" id="row11">
                <div class="box" id="box11"></div>
            </div>
            <div class="decryptr--row" id="row12">
                <div class="box" id="box12"></div>
            </div>
            <div class="decryptr--row" id="row13">
                <div class="box" id="box13"></div>
            </div>
            <div class="decryptr--row" id="row14">
                <div class="box" id="box14"> </div>
            </div>

            <div class="middlerow">
            
                <button class="suggest" id="suggestAnswer" disabled>
                    Suggest
                </button>
                <button disabled class="submit_clue" id="submitClues" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
                    Submit
                </button>
                <button disabled class="submitAnswer" id="submitAnswer">
                    Submit
                </button>
            </div>

            <div class="decryptr--row" id="row21">
                <div class="box" id="box21"></div>
            </div>
            <div class="decryptr--row" id="row22">
                <div class="box" id="box22"></div>
            </div>
            <div class="decryptr--row" id="row23">
                <div class="box" id="box23"></div>
            </div>
            <div class="decryptr--row" id="row24">
                <div class="box" id="box24"> </div>
            </div>
            </div>
        </div>
    </div>
</div>

    <ul id="messages"></ul>
    <form id="form" action="">
      <input id="input" autocomplete="off" /><button>Send</button>
    </form>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct"
        crossorigin="anonymous"></script>
<script src="script.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

<script src="/socket.io/socket.io.js"></script>
<script>
    var socket = io();
    let my_user_id = "";
    let my_name = "";
    let my_team = "";

    socket.on('connect', function() {
        console.log('connected');
        my_user_id = sessionStorage.getItem('user_id');
        my_team = sessionStorage.getItem('user_team');
        my_name = sessionStorage.getItem('user_name');
    });

    // new games: give new html to all users
    var newGames = document.getElementById('newGame');
    newGames.addEventListener('click', function(e) {
        socket.emit('newGames', my_user_id, my_name);
    });

    socket.on('newGame_JS', () => {
        console.log('received newGame signal');
        newGame_JS();
    });

    var startNewRound = document.getElementById('startNewRound');
    var giveClues = document.getElementById('giveClues');
    var submitAnswer = document.getElementById('submitAnswer');
    var submitClues = document.getElementById('submitClues');
    var suggest = document.getElementById('suggestAnswer');
    // button for sending giving-clues sinal: client that clicked the button is given
    // the html-change while others have the button greyed out
    
    giveClues.addEventListener('click', function(e) {
        console.log(my_user_id);
        socket.emit('giveClues',my_user_id, my_name , my_team);
    });

    // received give-clues signal: changes HTML accordingly 
    socket.on('giveClues_JS', (user_id, user_team, position_to_be_encoded) => {
        console.log('received giveClues_JS signal');
        if (my_user_id == user_id){
            console.log(my_name + ' is giving clues');
            giveClues.setAttribute('disabled', true);
            giveClues_JS(user_team, position_to_be_encoded);
            submitClues.disabled = false;
        } else if (my_team == user_team) {
            console.log('give clues button is greyed out for ' + my_name);
            giveClues.setAttribute('disabled', true);
        }
    });

    // button for sending submit-clues signal
    
    submitClues.addEventListener('click', function(e) {
        submitClues.setAttribute('disabled', true);
        socket.emit('submitClues', my_user_id, my_name, my_team, $(`#input${my_team}1`).html(), $(`#input${my_team}2`).html(), $(`#input${my_team}3`).html());
    });

    // received rearrangement singal: clues are now rearranged randomly
    socket.on('rearrangeClues_JS', ( user_id, user_name, user_team, input2_value, input3_value, input1_value, mixed_position) => {
        if (my_user_id != user_id && my_team == user_team){
            rearrangeClues_JS( user_id, user_name, user_team, input2_value, input3_value, input1_value, mixed_position);
            submitAnswer.disabled = false;
            suggest.disabled = false;
        }   
    });

    // button to send suggest-arrangement signal to server
    
    suggest.addEventListener('click', function(e) {
        console.log('suggested');
        let box1Children = document.getElementById(`box${my_team}1`).children;
        let box2Children = document.getElementById(`box${my_team}2`).children;
        let box3Children = document.getElementById(`box${my_team}3`).children;
        let box4Children = document.getElementById(`box${my_team}4`).children;

        let box1word;
        let box2word;
        let box3word;
        let box4word;

        if (box1Children.length > 0) {
            box1word = box1Children.item(0).innerHTML;} 
        else {
            box1word = 'null';}
        if (box2Children.length > 0) {
            box2word = box2Children.item(0).innerHTML;} 
        else {
            box2word = 'null';}
        if (box3Children.length > 0) {
            box3word = box3Children.item(0).innerHTML;} 
        else {
            box3word = 'null';}
        if (box4Children.length > 0) {
            box4word = box4Children.item(0).innerHTML;} 
        else {
            box4word = 'null';}

        let d = {
            'box1': box1word,
            'box2': box2word,
            'box3': box3word,
            'box4': box4word
            };
        console.log(d);
        socket.emit('suggestAnswer', my_user_id, my_name, my_team, d);
    });

    // receive suggest-rearrangement signal, displays for everyone to see
    socket.on('rearrangeSuggest_JS', ( user_name, user_team, d) => {
        console.log('received rearrangeSuggest_JS ');
        rearrangeSuggest_JS( user_name, user_team, d);
    });

    // button for sending submit-answers signal
    
    submitAnswer.addEventListener('click', function(e) {
        console.log('submitted answer');
        submitAnswer.disabled = true;
        suggest.disabled = true;
        let box1Children = document.getElementById(`box${my_team}1`).children;
        let box2Children = document.getElementById(`box${my_team}2`).children;
        let box3Children = document.getElementById(`box${my_team}3`).children;
        let box4Children = document.getElementById(`box${my_team}4`).children;

        let box1word;
        let box2word;
        let box3word;
        let box4word;

        if (box1Children.length > 0) {
            box1word = box1Children.item(0).innerHTML;} 
        else {
            box1word = 'null';}
        if (box2Children.length > 0) {
            box2word = box2Children.item(0).innerHTML;} 
        else {
            box2word = 'null';}
        if (box3Children.length > 0) {
            box3word = box3Children.item(0).innerHTML;} 
        else {
            box3word = 'null';}
        if (box4Children.length > 0) {
            box4word = box4Children.item(0).innerHTML;} 
        else {
            box4word = 'null';}

        let d = {
            'box1': box1word,
            'box2': box2word,
            'box3': box3word,
            'box4': box4word
            };
        console.log(d);
        socket.emit('submitAnswer', my_user_id, my_name, my_team, d);
    });


    // received communication result, push correct answers to the right
    socket.on('pushRight', (result, user_id, game_state_correct_answer, team) => {
        console.log('received pushRight');  
        pushRight(result, user_id, game_state_correct_answer);
        if (my_team == team) {      
            submitAnswer.disabled = true;
            suggest.disabled = true;
        }
    });

    // received roundComplete signal, reset boxes and enable giveClues; 
    socket.on('roundCompleted', () => {
        console.log('received roundCompleted');
        startNewRound.disabled = false;
    });

    // when click on start new round, send signal to clear everything from boxes, reset the clock, update var round, enable giveClues
    startNewRound.addEventListener('click', function(e) {
        console.log('start new round clicked');
        socket.emit('startNewRound', my_name);
    });

    // receive startNewRound_JS from server and update site
    socket.on('startNewRound_JS', (user_name) => {
        console.log('received startNewRound_JS');
        startNewRound_JS(user_name);
    });

    // make it draggable swappable for opponents
    // 


    // chat
    var messages = document.getElementById('messages');
    var form = document.getElementById('form');
    var input = document.getElementById('input');

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        if (input.value) {
        socket.emit('chat message', input.value);
        input.value = '';
        }
    });

    socket.on('chat message', function(msg) {
        var item = document.createElement('li');
        item.textContent = msg;
        messages.appendChild(item);
        window.scrollTo(0, document.body.scrollHeight);
    });

    

    
  
</script>

</body>
</html>