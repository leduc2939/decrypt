<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Document</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
          integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
            crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css" href="style.css" />      

</head>
<body class="body_game" id="body">
    
    <div class="whole" id = 'whole'>
      <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="staticBackdropLabel">Đúng nhận?</h5>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Sai cãi</button>
              <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Nhận</button>
            </div>
          </div>
        </div>
      </div>

    <div id = container>


    

    <div class="decryptr--head--row">
        
            <button id="startNewRound" class="game-button blue_new_round" disabled >
                New Round
            </button>
            <div class="countdown-container" id="countdown-container">
                <div id="countdown"></div>
            </div>

            <table>
                <tr>
                  <td class="table-cell">miscommunicate</td>
                  <td class="table-cell-blue" id="miscommunicate_blue">0</td>
                  <td class="table-cell-red" id="miscommunicate_red">0</td>
                </tr>
                <tr>
                  <td class="table-cell">intercept</td>
                  <td class="table-cell-blue" id="intercept_blue">0</td>
                  <td class="table-cell-red" id="intercept_red">0</td>
                </tr>
            </table>

            <button class="game-button blue_menu" id="menu-button">Menu</button>
            <div class="menu" id="menu">
      
                <button id="newGame" class="game-button red" >
                    New Game
                </button>
                <hr></hr>
                <div>Team Thua</div>
                <ul id="Team_Thua_Members">    

                </ul>      
                <div>Team Loser</div>
                <ul id="Team_Loser_Members">    

                </ul> 
            </div>

            <!-- <a href="javascript:;" class="arrow">◄</a>
                <ul class="menu">
                <li class="menu__item">
                    <button id="newGame">
                        New Game
                    </button>
                    </li>
                </ul> -->
    </div>



         
    
    
    <div class="decryptr d-flex">
        <div class="decryptr--left ">
<!-- team 1 keywords -->
            <div class="decryptr--row">
                <div id="team_1_word1" class="keyword1">
                    <span class="m-auto">?</span>
                </div>
            </div>

            <div class="decryptr--row">
                <div id="team_1_word2" class="keyword1">
                    <span class="m-auto">?</span>
                </div>
            </div>

            <div class="decryptr--row">
                <div id="team_1_word3" class="keyword1">
                    <span class="m-auto">?</span>
                </div>
            </div>

            <div class="decryptr--row">
                <div id="team_1_word4" class="keyword1">
                    <span class="m-auto">?</span>
                </div>
            </div>
            <div class="middlerow">
            <button class='game-button purple' id="giveClues" disabled>
                Give Clues
            </button>
            </div>

<!-- team 2 keywords -->
            <div class="decryptr--row">
                <div id="team_2_word1" class="decryptr--item2">
                    <span class="m-auto">?</span>
                </div>
            </div>

            <div class="decryptr--row">
                <div id="team_2_word2" class="decryptr--item2">
                    <span class="m-auto">?</span>
                </div>
            </div>

            <div class="decryptr--row">
                <div id="team_2_word3" class="decryptr--item2">
                    <span class="m-auto">?</span>
                </div>
            </div>

            <div class="decryptr--row">
                <div id="team_2_word4" class="decryptr--item2">
                    <span class="m-auto">?</span>
                </div>
            </div>
        </div>

        <div class="decryptr--box">
            <div class="decryptr--row" id="boxrow11">
                <div class="box" id="box11"></div>
            </div>
            <div class="decryptr--row" id="boxrow12">
                <div class="box" id="box12"></div>
            </div>
            <div class="decryptr--row" id="boxrow13">
                <div class="box" id="box13"></div>
            </div>
            <div class="decryptr--row" id="boxrow14">
                <div class="box" id="box14"> </div>
            </div>

            <div class="middlerow">
                <button class="game-button orange" id="suggestAnswer" disabled>
                    Suggest
                </button>
            </div>

            <div class="decryptr--row" id="boxrow21">
                <div class="box" id="box21"></div>
            </div>
            <div class="decryptr--row" id="boxrow22">
                <div class="box" id="box22"></div>
            </div>
            <div class="decryptr--row" id="boxrow23">
                <div class="box" id="box23"></div>
            </div>
            <div class="decryptr--row" id="boxrow24">
                <div class="box" id="box24"> </div>
            </div>

        </div>



        <div class="decryptr--right">
            <div class="decryptr--row" id="row11">
            </div>
            <div class="decryptr--row" id="row12">
            </div>
            <div class="decryptr--row" id="row13">
            </div>
            <div class="decryptr--row" id="row14">
            </div>


            

            <div class="middlerow">
                <!-- <button disabled class="game-button green" id="submitClues" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
                    Submit
                </button> -->
                <button disabled class="game-button green" id="submitClues"> 
                    Submit
                </button>
                <button disabled class="game-button green" id="submitAnswer">
                    Submit
                </button>
            </div>

            <div class="decryptr--row" id="row21">
            </div>
            <div class="decryptr--row" id="row22">
            </div>
            <div class="decryptr--row" id="row23">
            </div>
            <div class="decryptr--row" id="row24">
            </div>


            
            </div>
        </div>
    </div>

    

    
    <form id="form" action="">
      <input id="input" autocomplete="off" /><button class="game-button">Send</button>
    </form>
    <ul id="messages" class="messages"></ul>
</div>

</div>

   
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct"
        crossorigin="anonymous"></script>
<script src="script.js"></script>
<script src="https://cdn.jsdelivr.net/npm/uuid@latest/dist/umd/uuidv4.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>



<script src="/socket.io/socket.io.js"></script>
<script>

    var socket = io();
    
    let my_user_id = "";
    let my_name = "";
    let my_team = "";
    let phase = "1";
    let clue_giver = "";
    let game_state_full = {};
    game_state_full['team_1'] = {};
    game_state_full['team_2'] = {};

    let position_to_be_encoded = [];
    

    var body = document.getElementById('body');
    var whole = document.getElementById('whole');

    var thua_word1 = document.getElementById('thua_word1');
    
    var startNewRound = document.getElementById('startNewRound');
    var giveClues = document.getElementById('giveClues');
    var submitAnswer = document.getElementById('submitAnswer');
    var submitClues = document.getElementById('submitClues');
    var suggestAnswer = document.getElementById('suggestAnswer');
    var timerInterval;

    var miscommunicate_blue = document.getElementById('miscommunicate_blue');
    var miscommunicate_blue = document.getElementById('miscommunicate_red');
    var intercept_blue = document.getElementById('intercept_blue'); 
    var intercept_red = document.getElementById('intercept_red');

    socket.on('connect', function() {
        console.log('connected');
        if (sessionStorage.getItem('user_id')){
            my_user_id = sessionStorage.getItem('user_id');
            socket.emit('iden_user_id', my_user_id);
        } else {
            my_user_id = uuidv4();
            sessionStorage.setItem('user_id',my_user_id);
            sessionStorage.setItem('user_team','1');
            sessionStorage.setItem('user_name','noname');
            socket.emit('iden_user_id', my_user_id)
        } 
        my_user_id = sessionStorage.getItem('user_id');
        my_team = sessionStorage.getItem('user_team');
        my_name = sessionStorage.getItem('user_name');
        console.log(my_user_id);
        console.log(my_team);
        
        socket.emit('reconnect_sync_up', my_user_id, my_team);

    });

    socket.on('reconnect_sync_up_js', (game_state_full_server, current_phase, clue_giver, user_db) => {
        phase = current_phase;
        console.log(my_team);
        // console.log(game_state_full_server);
        reconnect_sync_up_js(my_user_id, my_team, game_state_full_server, current_phase, clue_giver,user_db);
        console.log(user_db);
        for (user_id in user_db) {
            if (user_db[user_id]['user_team'] == "1") {
                if (user_db[user_id]['user_team']){
                    var member = document.createElement('li');
                    member.textContent = user_db[user_id]['user_name'];
                    document.getElementById('Team_Thua_Members').appendChild(member);
                }
            } else {
                if (user_db[user_id]['user_team']){
                    var member = document.createElement('li');
                    member.textContent = user_db[user_id]['user_name'];
                    document.getElementById('Team_Loser_Members').appendChild(member);
                }
            }
        }
    }); 

    
    socket.on('team_member_update', (user_db) => {
        console.log('received update_team_member');
        console.log(user_db);
        for (user_id in user_db) {
            if (user_db[user_id]['user_team'] == "1") {
                if (user_db[user_id]['user_team']){
                    var member = document.createElement('li');
                    member.textContent = user_db[user_id]['user_name'];
                    document.getElementById('Team_Thua_Members').appendChild(member);
                }
            } else {
                if (user_db[user_id]['user_team']){
                    var member = document.createElement('li');
                    member.textContent = user_db[user_id]['user_name'];
                    document.getElementById('Team_Loser_Members').appendChild(member);
                }
            }
        }
        
    });

    // new games: give new html to all users
    var newGames = document.getElementById('newGame');
    newGames.addEventListener('click', function(e) {
        socket.emit('newGames', my_user_id, my_name);
    });

    // receive keywords from server
    socket.on('newGame_JS', (team_1_keywords,team_2_keywords) => {
        console.log('received newGame signal');
        if (my_team=="1") {
            newGame_JS(team_1_keywords, my_team);
        } else {
            newGame_JS(team_2_keywords, my_team);
        }
        phase = 1;
    });

    // function isScriptLoaded(url) {
    //     const scripts = document.querySelectorAll('script');
    //     for (const script of scripts) {
    //         if (script.src === url) {
    //         return script.readyState === 'loaded' || script.readyState === 'complete';
    //         }
    //     }
    //     return false;
    // }


    // button for sending giving-clues signal: client that clicked the button is given
    // the html-change while others have the button greyed out
    
    giveClues.addEventListener('click', function(e) {
        console.log(my_user_id);
        socket.emit('giveClues',my_user_id, my_name , my_team);
    });

    // received give-clues signal: changes HTML accordingly 
    socket.on('giveClues_JS', (user_id, user_team, position_to_be_encoded) => {
        console.log('received giveClues_JS signal');
        if (my_user_id == user_id){
            console.log(my_name + ' is giving clues');
            giveClues.disabled = true;
            giveClues_JS(user_team, position_to_be_encoded);
            submitClues.disabled = false;
            position_to_be_encoded = position_to_be_encoded;
        } else if (my_team == user_team) {
            console.log('give clues button is greyed out for ' + my_name);
            giveClues.disabled = true;
        }
        clue_giver = user_id;
    });

    // button for sending submit-clues signal
    
    submitClues.addEventListener('click', function(e) {
        submitClues.setAttribute('disabled', true);
        socket.emit('submitClues', my_user_id, my_name, my_team, $(`#input${my_team}1`).html(), $(`#input${my_team}2`).html(), $(`#input${my_team}3`).html());
        
        for (pos of position_to_be_encoded){
            document.getElementById(`box${my_team}${position_to_be_encoded[pos]}`).setAttribute('contenteditable', 'false');
        }
        
    });

    // received rearrangement singal: clues are now rearranged randomly
    socket.on('rearrangeClues_JS', ( user_id, user_name, user_team, input1_value, input2_value, input3_value, mixed_position) => {
        if (my_user_id != user_id && my_team == user_team){
            rearrangeClues_JS( user_id, user_name, user_team, input1_value, input2_value, input3_value, mixed_position);
            submitAnswer.disabled = false;
            suggestAnswer.disabled = false;
        }   
    });

    // button to send suggest-arrangement signal to server
    
    suggestAnswer.addEventListener('click', function(e) {
        console.log('suggested');
        if (phase =="2") {
            var other_team = '';
            if (my_team == '1'){
                other_team = '2';
            } else {
                other_team = '1';
            }

            let box1Children = document.getElementById(`box${other_team}1`).children;
            let box2Children = document.getElementById(`box${other_team}2`).children;
            let box3Children = document.getElementById(`box${other_team}3`).children;
            let box4Children = document.getElementById(`box${other_team}4`).children;

            let box1word;
            let box2word;
            let box3word;
            let box4word;

            if (box1Children.length > 0) {
                box1word = box1Children.item(0).innerHTML;} 
            else {
                box1word = 'null';}
            if (box2Children.length > 0) {
                box2word = box2Children.item(0).innerHTML;} 
            else {
                box2word = 'null';}
            if (box3Children.length > 0) {
                box3word = box3Children.item(0).innerHTML;} 
            else {
                box3word = 'null';}
            if (box4Children.length > 0) {
                box4word = box4Children.item(0).innerHTML;} 
            else {
                box4word = 'null';}
            
            let d = {};
            d[`box${other_team}1`] = box1word;
            d[`box${other_team}2`] = box2word;
            d[`box${other_team}3`] = box3word;
            d[`box${other_team}4`] = box4word;
            
            console.log(d);
            socket.emit('suggestAnswer', my_user_id, my_name, my_team, d);

        } else {
            let box1Children = document.getElementById(`box${my_team}1`).children;
            let box2Children = document.getElementById(`box${my_team}2`).children;
            let box3Children = document.getElementById(`box${my_team}3`).children;
            let box4Children = document.getElementById(`box${my_team}4`).children;

            let box1word;
            let box2word;
            let box3word;
            let box4word;

            if (box1Children.length > 0) {
                box1word = box1Children.item(0).innerHTML;} 
            else {
                box1word = 'null';}
            if (box2Children.length > 0) {
                box2word = box2Children.item(0).innerHTML;} 
            else {
                box2word = 'null';}
            if (box3Children.length > 0) {
                box3word = box3Children.item(0).innerHTML;} 
            else {
                box3word = 'null';}
            if (box4Children.length > 0) {
                box4word = box4Children.item(0).innerHTML;} 
            else {
                box4word = 'null';}

            let d = {};
            d[`box${my_team}1`] = box1word;
            d[`box${my_team}2`] = box2word;
            d[`box${my_team}3`] = box3word;
            d[`box${my_team}4`] = box4word;

            console.log(d);
            socket.emit('suggestAnswer', my_user_id, my_name, my_team, d);
        }
    });

    // receive suggest-rearrangement signal, displays for everyone to see
    socket.on('rearrangeSuggest_JS', ( user_name, user_team, d, phase) => {
        console.log('received rearrangeSuggest_JS ');

        if (user_team == my_team) {           
        rearrangeSuggest_JS( user_name, user_team, d, phase);
        }
    });

    // button for sending submit-answers signal
    
    submitAnswer.addEventListener('click', function(e) {
        socket.emit('stopClock', my_team);
        console.log('phase is: ' +phase);
        submitAnswer.disabled = true;
        suggestAnswer.disabled = true;
        if (phase=="2") {
            var other_team = '';
            if (my_team == '1'){
                other_team = '2';
            } else {
                other_team = '1';
            }
            let box1Children = document.getElementById(`box${other_team}1`).children;
            let box2Children = document.getElementById(`box${other_team}2`).children;
            let box3Children = document.getElementById(`box${other_team}3`).children;
            let box4Children = document.getElementById(`box${other_team}4`).children;

            let box1word;
            let box2word;
            let box3word;
            let box4word;

            if (box1Children.length > 0) {
                box1word = box1Children.item(0).innerHTML;} 
            else {
                box1word = 'null';}
            if (box2Children.length > 0) {
                box2word = box2Children.item(0).innerHTML;} 
            else {
                box2word = 'null';}
            if (box3Children.length > 0) {
                box3word = box3Children.item(0).innerHTML;} 
            else {
                box3word = 'null';}
            if (box4Children.length > 0) {
                box4word = box4Children.item(0).innerHTML;} 
            else {
                box4word = 'null';}

            let d = {
                'box1': box1word,
                'box2': box2word,
                'box3': box3word,
                'box4': box4word
                };
            console.log(d);
            socket.emit('submitAnswer', my_user_id, my_name, other_team, d);
            console.log('submitted interception answer');
        } 
        else {
            let box1Children = document.getElementById(`box${my_team}1`).children;
            let box2Children = document.getElementById(`box${my_team}2`).children;
            let box3Children = document.getElementById(`box${my_team}3`).children;
            let box4Children = document.getElementById(`box${my_team}4`).children;

            let box1word;
            let box2word;
            let box3word;
            let box4word;

            if (box1Children.length > 0) {
                box1word = box1Children.item(0).innerHTML;} 
            else {
                box1word = 'null';}
            if (box2Children.length > 0) {
                box2word = box2Children.item(0).innerHTML;} 
            else {
                box2word = 'null';}
            if (box3Children.length > 0) {
                box3word = box3Children.item(0).innerHTML;} 
            else {
                box3word = 'null';}
            if (box4Children.length > 0) {
                box4word = box4Children.item(0).innerHTML;} 
            else {
                box4word = 'null';}

            let d = {
                'box1': box1word,
                'box2': box2word,
                'box3': box3word,
                'box4': box4word
                };
            console.log(d);
            socket.emit('submitAnswer', my_user_id, my_name, my_team, d);
            console.log('submitted communication answer');
        }
        
    });


    // received communication result, push correct answers to the right
    socket.on('pushRight', (result, user_id, game_state_correct_answer, team) => {
        console.log('received pushRight for my team');  
        if (my_team == team) {      
            submitAnswer.disabled = true;
            suggestAnswer.disabled = true;
            pushRight(result, user_id, game_state_correct_answer);
            
        }
        if (result==0) {
            if (team=="1"){
                var newvalue = parseInt(miscommunicate_blue.textContent) + 1;
                miscommunicate_blue.textContent = newvalue;
            } else{
                var newvalue = parseInt(miscommunicate_red.textContent) + 1;
                miscommunicate_red.textContent = newvalue;
            }
        }
    });

    // received roundComplete signal, reset boxes and enable giveClues; 
    socket.on('roundCompleted', () => {
        console.log('received roundCompleted');
        startNewRound.disabled = false; 
        countdownDisplay.textContent = "";
    });

    // when click on start new round, send signal to clear everything from boxes, reset the clock, update var round, enable giveClues
    startNewRound.addEventListener('click', function(e) {
        console.log('start new round clicked');
        socket.emit('startNewRound', my_name);
        giveClues.disabled = false;
        submitClues.hidden = false;
        submitAnswer.hidden = true;
        startNewRound.disabled = true;
    });
    const countdownDisplay = document.getElementById('countdown');
    
    
    // receive startNewRound_JS from server and update site
    socket.on('startNewRound_JS', (user_name) => {
        console.log('received startNewRound_JS');
        startNewRound_JS(user_name);
        phase = '1';
        giveClues.disabled = false;
        submitClues.hidden = false;
        submitAnswer.hidden = true;
        startNewRound.disabled = true;

        let remainingTime = 5 * 60; // 5 minutes in seconds
        timerInterval = setInterval(() => {
            if (remainingTime <= 0) {
                clearInterval(timerInterval);
                countdownDisplay.textContent = "Time's up";
                return;
            }

            const minutes = Math.floor(remainingTime / 60);
            const seconds = remainingTime % 60;

            countdownDisplay.textContent = `${minutes}:${seconds}`;

            remainingTime--;
        }, 1000); // Update the countdown every second
 
    });

    // make it draggable swappable for opponents
    socket.on('rearrangeClues_intercept_JS', (round_d, mixed_position) => {
        console.log('received rearrangeClues_intercept_JS');
        phase = "2";
        rearrangeClues_intercept_JS(round_d, mixed_position, my_team);
        submitAnswer.hidden = false;
        submitClues.hidden = true;
        submitAnswer.disabled = false;
        suggestAnswer.disabled = false;

        clearInterval(timerInterval);
        var remainingTime = 5 * 60; // 5 minutes in seconds
        timerInterval = setInterval(() => {
            if (remainingTime <= 0) {
                clearInterval(timerInterval);
                countdownDisplay.textContent = "Time's up";
                return;
            }

            var minutes = Math.floor(remainingTime / 60);
            var seconds = remainingTime % 60;

            countdownDisplay.textContent = `${minutes}:${seconds}`;

            remainingTime--;
        }, 1000); // Update the countdown every second
    });

    // receive intercept_res, lock submit button
    socket.on('intercept_res', (result, user_name, game_state_correct_answer, user_team) => {
        console.log(user_team);
        console.log('intercept_res received');
        if (my_team!=user_team) {
            console.log('its my team');
            intercept_res_JS(result, user_name, game_state_correct_answer);
        }
        if (result==1) {
            if (user_team=="2"){
                var newvalue = parseInt(intercept_blue.textContent) + 1;
                intercept_blue.textContent = newvalue;
            } else{
                var newvalue = parseInt(intercept_red.textContent) + 1;
                intercept_red.textContent = newvalue;
            }
    }
    
    });

    // chat
    var messages = document.getElementById('messages');
    var form = document.getElementById('form');
    var input = document.getElementById('input');

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        if (input.value) {
        socket.emit('chat message', input.value, my_name);
        input.value = '';
        }
    });

    socket.on('chat message', function(msg, user_name) {
        var named_msg = `${user_name}: ${msg}`; 
        var item = document.createElement('li');
        item.textContent = named_msg;
        messages.prepend(item);
        window.scrollTo(0, document.body.scrollHeight);
    });

    socket.on('redirecttonewgame', newgameurl => {
    // redirect to new url
    window.location = newgameurl;
    });

    
    const menuButton = document.getElementById('menu-button');
    const menuElement = document.getElementById('menu');

    menuButton.addEventListener('click', () => {
        const menuButtonPosition = menuButton.getBoundingClientRect();
        const menuElementWidth = menuElement.offsetWidth;

        menuElement.style.right = `${window.innerWidth - menuButtonPosition.right}px`;
        menuElement.style.top = `${menuButtonPosition.top + menuButton.offsetHeight}px`;
        menuElement.style.display = menuElement.style.display === 'block' ? 'none' : 'block';
    });

    socket.on('server_stopClock', (user_team)=>{
        console.log('stopClock received');
        if (my_team==user_team){
            clearInterval(timerInterval);
        }
        
    });

    // socket.on('server_clearClock', ()=>{
    //     console.log('clearClock received');
    //     countdownDisplay.textContent = "";
        
    // });
        
  
</script>

</body>
</html>